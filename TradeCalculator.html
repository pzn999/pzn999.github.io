<!DOCTYPE html>
<html lang="it">
<head>dal testo
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trade Calculator ‚Äì PL Corretto</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f9f9f9;
      color: #222;
    }
    h2 {
      text-align: center;
      color: #1976d2;
      margin-bottom: 20px;
    }
    .row {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }
    .row button {
      flex: 1;
    }
    textarea {
      width: 100%;
      height: 160px;
      font-size: 16px;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      font-family: monospace;
    }
    .btn {
      background: #1976d2;
      color: white;
      border: none;
      padding: 14px 20px;
      font-size: 17px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn:hover { background: #1565c0; }
    .btn:disabled { background: #b0bec5; cursor: not-allowed; }
    .btn-clear {
      background: #607d8b;
    }
    .btn-clear:hover { background: #455a64; }
    .info {
      font-size: 14px;
      color: #666;
      text-align: center;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <h2>üìä Trade Calculator ‚Äì PL Corretto</h2>
  
  <!-- Campo Rischio: corto e allineato -->
  <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
    <label for="risk" style="margin: 0; font-weight: bold; white-space: nowrap;">Rischio (USD)</label>
    <input type="number" id="risk" value="1250" min="1" step="50" style="width: 120px; padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px;">
  </div>
  
  <div class="row">
    <button id="autoBtn" class="btn">üì±üì• Incolla e Calcola</button>
    <button id="clearBtn" class="btn btn-clear">üßπ Pulisci</button>
  </div>
  
  <p style="text-align:center; margin:8px 0; color:#666;">‚Äî oppure incolla manualmente ‚Äî</p>
  
  <textarea id="input" placeholder="Esempio:
‚úÖ SELL BTCUSD
üìä ENTRY: 47990
üí∞TP1: 47840
üí∞TP2: 47500
‚úã SL : 48105"></textarea>
  
  <button onclick="processManual()" class="btn">üíª Calcola</button>
  
  <div id="output" style="margin-top: 20px; background: white; padding: 16px; border-radius: 8px; border: 1px solid #ddd;"></div>

  <script>
    const SYMBOL_CONFIG = {
      "XAUUSD": { UnitsPerLot: 100,    PipsPerPrezzo: 100 },
      "EURUSD": { UnitsPerLot: 100000, PipsPerPrezzo: 10000 },
      "BTCUSD": { UnitsPerLot: 1,      PipsPerPrezzo: 10 },
      "ETHUSD": { UnitsPerLot: 1,      PipsPerPrezzo: 10 },
      "US500":  { UnitsPerLot: 1,      PipsPerPrezzo: 1 },
      "US100":  { UnitsPerLot: 1,      PipsPerPrezzo: 1 },
      "US30":   { UnitsPerLot: 1,      PipsPerPrezzo: 1 }
    };

    function getLastWord(str) {
      if (!str) return null;
      const words = str.trim().split(/\s+/);
      return words.length > 0 ? words[words.length - 1] : null;
    }

    function parseNumber(str) {
      if (!str) return null;
      let clean = str.replace(/\./g, '').replace(/,/g, '.');
      const num = parseFloat(clean);
      return isNaN(num) ? null : num;
    }

    function extractData(text) {
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      let symbol = null;

      if (lines.length > 0) {
        const knownSymbols = Object.keys(SYMBOL_CONFIG);
        for (const sym of knownSymbols) {
          if (lines[0].includes(sym)) {
            symbol = sym;
            break;
          }
        }
      }

      let entry = null, tp1 = null, tp2 = null, tp3 = null, sl = null;
      for (const line of lines) {
        const u = line.toUpperCase();
        if (u.includes("ENTRY")) entry = parseNumber(getLastWord(line));
        if (u.includes("TP1"))   tp1 = parseNumber(getLastWord(line));
        if (u.includes("TP2"))   tp2 = parseNumber(getLastWord(line));
        if (u.includes("TP3"))   tp3 = parseNumber(getLastWord(line));
        if (u.includes("SL"))    sl = parseNumber(getLastWord(line));
      }

      return { symbol, entry, tp1, tp2, tp3, sl };
    }

    // ‚úÖ Formattazione: nessun "+" per positivi, "-" per negativi
    function formatPL(value) {
      return Math.round(value).toString();
    }

    function processText(text) {
      const risk = parseFloat(document.getElementById('risk').value);
      if (!risk || risk <= 0) {
        document.getElementById('output').innerHTML = "<pre>‚ùå Rischio non valido</pre>";
        return;
      }

      if (!text?.trim()) {
        document.getElementById('output').innerHTML = "<pre>‚ùå Testo mancante</pre>";
        return;
      }

      try {
        const data = extractData(text);
        if (!data.symbol || !data.entry || !data.tp1 || !data.tp2 || !data.sl) {
          throw new Error("Mancano: ENTRY, SL, TP1, TP2");
        }

        const config = SYMBOL_CONFIG[data.symbol];
        if (!config) throw new Error(`Simbolo non supportato: ${data.symbol}`);

        const { UnitsPerLot, PipsPerPrezzo } = config;
        const d = Math.abs(data.entry - data.sl);
        if (d === 0) throw new Error("SL = Entry");

        const lots = (risk / (d * UnitsPerLot)).toFixed(2);

        // ‚úÖ Pips (sempre positivi)
        const slpips = Math.round(d * PipsPerPrezzo);
        const tp1pips = Math.round(Math.abs(data.tp1 - data.entry) * PipsPerPrezzo);
        const tp2pips = Math.round(Math.abs(data.tp2 - data.entry) * PipsPerPrezzo);
        let tp3pips = null;
        if (data.tp3 !== null) {
          tp3pips = Math.round(Math.abs(data.tp3 - data.entry) * PipsPerPrezzo);
        }

        // ‚úÖ CALCOLO CORRETTO DEL PL
        const lotsNum = parseFloat(lots);

        // Perdita: sempre negativa
        const slpl = -Math.abs((data.entry - data.sl) * lotsNum * UnitsPerLot);

        // Profitti: sempre positivi
        const tp1pl = Math.abs((data.tp1 - data.entry) * lotsNum * UnitsPerLot);
        const tp2pl = Math.abs((data.tp2 - data.entry) * lotsNum * UnitsPerLot);
        let tp3pl = null;
        if (data.tp3 !== null) {
          tp3pl = Math.abs((data.tp3 - data.entry) * lotsNum * UnitsPerLot);
        }

        // Colori
        const bgColorEntry = "#e8f5e9";
        const bgColorTP = "#e3f2fd";
        const bgColorSL = "#fff3e0";

        let rows = [];
        rows.push(`<tr><td>Lots: ${lots}</td><td></td></tr>`);
        rows.push(`<tr><td colspan="2" style="height:12px;"></td></tr>`);
        rows.push(`<tr style="background-color:${bgColorEntry};"><td>Entry: ${data.entry}</td><td></td></tr>`);
        rows.push(`<tr><td colspan="2" style="height:12px;"></td></tr>`);
        
        // TP1
        rows.push(`<tr style="background-color:${bgColorTP};"><td>TP1 pips: ${tp1pips} (${formatPL(tp1pl)} $)</td><td>TP1: ${data.tp1}</td></tr>`);
        // TP2
        rows.push(`<tr style="background-color:${bgColorTP};"><td>TP2 pips: ${tp2pips} (${formatPL(tp2pl)} $)</td><td>TP2: ${data.tp2}</td></tr>`);
        // TP3 (opzionale)
        if (data.tp3 !== null) {
          rows.push(`<tr style="background-color:${bgColorTP};"><td>TP3 pips: ${tp3pips} (${formatPL(tp3pl)} $)</td><td>TP3: ${data.tp3}</td></tr>`);
        }
        rows.push(`<tr><td colspan="2" style="height:12px;"></td></tr>`);
        // SL
        rows.push(`<tr style="background-color:${bgColorSL};"><td>SL pips: ${slpips} (${formatPL(slpl)} $)</td><td>SL: ${data.sl}</td></tr>`);

        const tableHTML = `
          <table style="width:100%; border-collapse: collapse; font-family: monospace; font-size:16px; line-height:1.6;">
            ${rows.join('')}
          </table>
        `;

        document.getElementById('output').innerHTML = tableHTML;
        document.getElementById('input').value = text;
      } catch (err) {
        document.getElementById('output').innerHTML = `<pre>‚ùå ${err.message}</pre>`;
      }
    }

    function processManual() {
      const text = document.getElementById('input').value;
      processText(text);
    }

    async function autoPasteAndCalculate() {
      const input = document.getElementById('input');
      const btn = document.getElementById('autoBtn');
      input.value = '';
      btn.disabled = true;
      btn.textContent = "‚è≥ Lettura...";

      try {
        const text = await navigator.clipboard.readText();
        processText(text);
      } catch (err) {
        const isAndroid = /android/i.test(navigator.userAgent);
        if (isAndroid && window.location.protocol === "file:") {
          document.getElementById('output').innerHTML = 
            `<pre>üì± Su Android da file, la clipboard non √® accessibile.\n\nüëâ Tocca nella casella ‚Üí Incolla ‚Üí Premi "üíª Calcola dal testo"</pre>`;
        } else {
          document.getElementById('output').innerHTML = 
            `<pre>‚ÑπÔ∏è Incolla manualmente (Ctrl+V o tocco lungo ‚Üí Incolla)</pre>`;
        }
      } finally {
        btn.disabled = false;
        btn.textContent = "üì±üì• Incolla e Calcola";
      }
    }

    function clearAll() {
      document.getElementById('input').value = '';
      document.getElementById('output').innerHTML = '<pre>Pulito.</pre>';
    }

    document.getElementById('autoBtn').addEventListener('click', autoPasteAndCalculate);
    document.getElementById('clearBtn').addEventListener('click', clearAll);
  </script>
</body>
</html>


